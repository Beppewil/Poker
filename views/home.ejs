<!DOCTYPE html>
<html lang="en" id="htmlpage" style="background-color: gray;">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/views/style.css" rel="stylesheet" type="text/css" />
  <title>Home</title>
</head>
<body>
  <script>
    var lobbiesIDs = <%- JSON.stringify(lobbiesIDs) %>;
  </script>

  <h1 id="pokerTitle">Poker</h1>

  <!-- Toggle switch for background color -->
  <div class="toggle-container">
    <input type="checkbox" id="colorToggle" class="toggle">
    <label for="colorToggle" class="toggle-label"></label>
  </div>

  <label for="change-username-button" id="username-label"></label>
  <button id="change-username-button">CHANGE USERNAME</button>
  <button id="delete-cookies-button">Turn off cookies</button>

  <!-- Create Game Button -->
  <button id="createGame">Create Game</button>
  <form action="/createLobby" method="post" id="createGameForm" class="">
    <br><br>
    <button type="button" id="createGameBackButton"><</button>
    <div class="radio-group">
      <label for="poker_radio">Poker</label>
      <input type="radio" id="poker_radio" name="game_type" value="poker" checked>
      <label for="blackjack_radio">Blackjack</label>
      <input type="radio" id="blackjack_radio" name="game_type" value="blackjack">
    </div>
    <br><br>
    <div class="inputLabel">Game Name:</div><br><br>
    <input type="text" id="gameName" size="20" name="gameName" placeholder="Enter Game Name" class="formText"><br><br><br><br>
    <div class="inputLabel">Small Blind Value:</div><br><br>
    <input type="number" id="blindValue" size="20" name="blindValue" placeholder="Enter Small Blind Value" class="formText" min="1"><br><br><br>
    <div class="inputLabel">Private Lobby</div><br><br>
    <input type="checkbox" id="privateCheckbox" name="privateCheckbox" value="true"><br>
    <input type="password" id="passwordInput" class="formText" size="20" name="gamePassword" placeholder="Enter Password"><br><br><br><br>
    <button type="submit" id="submitForm">Create Game</button>
  </form>

  <!-- Join Game Section -->
  <button class="homeButton" id="joinGame">Join Game</button>
  <div id="lobbyFormWrapper">
    <button id="joinGameBackButton"><</button>
    <form action="/" method="post" id="lobbyForm">
      <!-- Refresh Button -->
      <button type="button" id="refreshLobbies">Refresh Lobbies</button>
      <!-- Lobby List Container -->
      <div id="lobbyListContainer"></div>
    </form>
  </div>

  <script src="/socket.io/socket.io.js" defer></script>
  <script type="module" defer>
    import { socket, setCookie, getCookie, checkCookie, deleteCookie } from './socket.js';

    // Create Game Toggle
    const createGame = document.getElementById('createGame');
    const createGameBackButton = document.getElementById('createGameBackButton');
    createGame.addEventListener('click', createGameForm);
    createGameBackButton.addEventListener('click', createGameForm);

    function createGameForm() {
      document.getElementById('createGameForm').classList.toggle('active');
      createGameBackButton.classList.toggle('active');
    }

    // Private Lobby Password Toggle
    const privateCheckbox = document.getElementById('privateCheckbox');
    const passwordInput = document.getElementById('passwordInput');
    privateCheckbox.addEventListener('click', () => passwordInput.classList.toggle("active"));

    // Blind Value Input Restriction
    const blindValue = document.getElementById('blindValue');
    blindValue.addEventListener('keydown', (e) => {
      if (!e.key.match(/^(\d|Backspace|ArrowLeft|ArrowRight)$/)) e.preventDefault();
    });

    // Create Game Form Submission
    const gameName = document.getElementById('gameName');
    const submitForm = document.getElementById('submitForm');
    submitForm.addEventListener('click', (e) => {
      e.preventDefault();
      if (
        gameName.value.trim() !== '' &&
        blindValue.value.trim() !== '' &&
        !lobbiesIDs.find(lobby => lobby.name.toLowerCase() === gameName.value.toLowerCase())
      ) {
        document.getElementById('createGameForm').submit();
      } else {
        if (gameName.value.trim() === '' || lobbiesIDs.find(lobby => lobby.name.toLowerCase() === gameName.value.toLowerCase())) {
          gameName.classList.add("notFilled");
        } else gameName.classList.remove("notFilled");
        if (blindValue.value.trim() === '') blindValue.classList.add("notFilled"); else blindValue.classList.remove("notFilled");
        if (lobbiesIDs.find(lobby => lobby.name.toLowerCase() === gameName.value.toLowerCase())) alert("Lobby  Taken");
      }Name
    });

    // Join Game Toggle
    const joinGameButton = document.getElementById('joinGame');
    const joinGameBackButton = document.getElementById('joinGameBackButton');
    joinGameButton.addEventListener('click', joinGameBTN);
    joinGameBackButton.addEventListener('click', joinGameBTN);
    function joinGameBTN() {
      document.getElementById('lobbyFormWrapper').classList.toggle('active');
      socket.emit("getLobbies")
    }

    // Render Lobbies
    const lobbyListContainer = document.getElementById("lobbyListContainer");
    const refreshButton = document.getElementById("refreshLobbies");
    const lobbyForm = document.getElementById("lobbyForm");

    function renderLobbies(lobbies) {
      lobbyListContainer.innerHTML = "";
      lobbies.forEach(lobby => {
        const div = document.createElement("div");
        div.classList.add("lobbyList");

        div.innerHTML = `
          <div style="margin-bottom:10px;"><b><u>${lobby.name}'s Lobby</u></b></div>
          <div>Game Type: ${lobby.game_type}</div>
          <div>Small Blind: ${lobby.blind}</div>
          <div>Players: ${lobby.players}/${lobby.game_type === "poker" ? 8 : 3}</div>
          <div>Private: ${lobby.private}</div>
          <button type="button" class="joinButton" value="${lobby.id}">Join Lobby</button>
        `;

        div.querySelector(".joinButton").addEventListener("click", () => {
          if (lobby.private) {
            const password = prompt("Enter password for this private lobby:");
            socket.emit("joinPrivateLobby", lobby.id, password);
          } else {
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "lobbyId";
            hiddenInput.value = lobby.id;
            lobbyForm.appendChild(hiddenInput);
            lobbyForm.submit();
          }
        });

        lobbyListContainer.appendChild(div);
      });
    }

    // Initial render
    renderLobbies(lobbiesIDs);

    // Refresh Button
    refreshButton.addEventListener("click", () => socket.emit("getLobbies"));
    
    socket.on("lobbiesData", (lobbies) => renderLobbies(lobbies));

    // Background Toggle
    const colorToggle = document.getElementById('colorToggle');
    const htmlpage = document.getElementById('htmlpage');
    colorToggle.addEventListener('change', () => {
      if (colorToggle.checked) {
        htmlpage.style.backgroundColor = '';
        htmlpage.classList.add('rainbow');
      } else {
        htmlpage.style.backgroundColor = 'gray';
        htmlpage.classList.remove('rainbow');
      }
    });

    // Username Handling
    const USERNAME_BUTTON = document.getElementById("change-username-button");
    if (!checkCookie()) setUsername();
    USERNAME_BUTTON.addEventListener("click", setUsername);
    function setUsername() {
      let username = prompt("Enter your username:");
      setCookie("username", username, 1);
      document.getElementById("username-label").textContent = getCookie("username") || "";
    }
    document.getElementById("username-label").textContent = getCookie("username") || "";

    // Delete Cookies
    document.getElementById('delete-cookies-button').addEventListener('click', () => {
      deleteCookie('username');
      document.getElementById("username-label").textContent = getCookie("username") || "";
    });
  </script>
</body>
</html>
